<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Nodetoy Chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
    crossorigin="anonymous" type="text/css" />
    <style type="text/css">
/*<![CDATA[*/
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        height: 100%;
        font: 13px Helvetica, Arial;
    }
    .header-padding {
        padding-top: 60px;
    }
    #messages { 
        list-style-type: none; 
        margin: 0; 
        padding: 0; 
    }
    #messages li { 
        padding: 5px 10px; 
    }
    #messages li.update { 
        color:blue; 
    }
    #messages li:nth-child(odd) { 
        background: #eee; 
    }
    .chat-main { 
        height:100vh;}
    .chat-log { 
        height: calc(100% - 85px);
        overflow:auto;
    }
    .chat-input { 
        bottom: 0;
        height: 35px;
    }
    #fm {
        width:100%;
    }
/*]]>*/
    </style>
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Nodetoy Chat</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="https://github.com/nathanrosspowell/nodetoy">On GitHub</a></li>

                    <li><a href="http://nathanrosspowell.com">nathanrosspowell.com</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
    <div class="container">
        <div class="col-sm-3  chat-sidebar header-padding">
            <h1>Settings</h1>
            <form id="fn" action="">
                <div class="form-group">
                    <label for="n">Change Name:</label>
                    <input id="n" autocomplete="off" type="text" class="form-control" placeholder="Superman">
                </div>
                <button type="submit" class="btn btn-default">Set</button>
            </form>
            <h1>Users</h1>
            <ul id="users"></ul>
            <h1>Typing</h1>
            <ul id="typers"></ul>
        </div>
        <div class="col-sm-8 col-sm-offset-1 chat-main header-padding">
            <div id="chat-scroll" class="chat-log">
                <ul id="messages" class="list-group"></ul>
            </div>
            <hr/>
            <div class="chat-input">
                <form id="fm" action="" class="form-inline">
                  <div class="form-group">
                    <label for="m">Write:</label>
                    <input id="m" autocomplete="off" type="text" class="form-control" placeholder="Hello, world!">
                  </div>
                  <button type="submit" class="btn btn-default">Send</button>
                </form>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous" type="text/javascript"></script>
    <script type="text/javascript">
//<![CDATA[
$(function(){
    var isTyping = {}
    var localUser = {}

    function stopTyping(id) {
        delete isTyping[id]
        $('#typer'+id).remove()
    }

    function addChat(data){
        addToLogAndScroll(data.name + ": " + data.msg, "")
    }

    function addUpdate(message){
        addToLogAndScroll('> ' +message, "list-group-item update")
    }

    function addToLogAndScroll(message, classType){
        var out = document.getElementById("chat-scroll")
        var isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + 1
        console.log(out.scrollHeight - out.clientHeight,  out.scrollTop + 1)
        $('#messages').append($('<li>').addClass("list-group-item " + classType).text(message))
        console.log(isScrolledToBottom)
        if(isScrolledToBottom) {
            out.scrollTop = out.scrollHeight - out.clientHeight
        }
    }

    var socket = io()

    $('#fm').submit(function(){
        var msg = $('#m').val()
        if (msg && msg.length > 0) {
            socket.emit('chat', msg)
            addChat(jQuery.extend({msg:msg}, localUser))
            $('#m').val('')
        }
        return false
    })

    $('#m').on('input', function() {
        socket.emit('is_typing');
    })

    $('#fn').submit(function(){
        var name = $('#n').val()
        if (name && name.length > 0) {
            socket.emit('name_change', name)
        }
        return false
    })

    socket.on('is_typing', function(user){
        if (user.id in isTyping){
            clearTimeout(isTyping[user.id])
        }
        else {
            $('#typers').append($('<li>').attr('id', 'typer'+user.id).text(user.name + "..."))
        }
        isTyping[user.id] = setTimeout(stopTyping, 2000, user.id, user.name)
    })

    socket.on('connection', function(user){
        localUser = user
        addUpdate('Welcome, "' + user.name + '"!')
    })

    socket.on('chat', function(data){
        addChat(data)
        stopTyping(data.id)
    })

    socket.on('user_list', function(list){
        for (i = 0; i < list.length; i++) { 
            var user = list[i]
            $('#users').append($('<li>').attr('id', 'user'+user.id).text(user.name))
        }
    })

    socket.on('user_add', function(user){
        $('#users').append($('<li>').attr('id', 'user'+user.id).text(user.name))
        addUpdate('"' + user.name + '" joined.')
    })

    socket.on('user_remove', function(user){
        $('#user'+user.id).remove()
        addUpdate('"' + user.name + '" left.')
    })

    socket.on('name_change', function(user){
        var oldName = "server_error"
        var userList = $('#user'+user.id)
        if (userList.get(0)){
            oldName = userList.text()
            userList.text(user.name)
            addUpdate('"' + oldName + '" changed name to  "' + user.name + '"')
        }
        else {
            var oldName = localUser.name
            localUser.name = user.name
            addUpdate('You changed your name to  "' + user.name + '"')
        }
        $('#user'+user.id).text(user.name)
        if (user.id in isTyping){
            $('#typer'+user.id).text(user.name+"...");
        }
    })
});
//]]>
    </script>
</body>
</html>
