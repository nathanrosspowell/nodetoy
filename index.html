<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Nodetoy Chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
    crossorigin="anonymous" type="text/css" />
    <style type="text/css">
/*<![CDATA[*/
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        height: 100%;
        font: 13px Helvetica, Arial;
    }
    .header-padding {
        padding-top: 60px;
    }
    #messages { 
        list-style-type: none; 
        margin: 0; 
        padding: 0; 
    }
    #messages li { 
        padding: 5px 10px; 
    }
    #messages li.update { 
        color:blue; 
    }
    #messages li:nth-child(odd) { 
        background: #eee; 
    }
    .chat-main { 
        height:100vh;}
    .chat-log { 
        height: calc(100% - 300px);
        overflow:auto;
    }
    .chat-input { 
        bottom: 0;
        height: 35px;
    }
    #fm {
        width:100%;
    }

/*]]>*/
    </style>
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Nodetoy Chat</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="https://github.com/nathanrosspowell/nodetoy">On GitHub</a></li>

                    <li><a href="http://nathanrosspowell.com">nathanrosspowell.com</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
    <div class="container">
        <div class="col-sm-3  chat-sidebar header-padding">
            <h1>Settings</h1>
            <form id="fn" action="" class="form-inline">
                <div class="form-group">
                    <input id="n" autocomplete="off" type="text" class="form-control">
                </div>
                <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-log-in" aria-hidden="true"></span></button>
            </form>
            <h1>Users</h1>
            <ul id="users"></ul>
            <h1>Typing</h1>
            <ul id="typers"></ul>
        </div>
        <div class="col-sm-8 chat-main header-padding">
            <div id="chat-scroll" class="chat-log">
                <div id="messages" class="list-group"></div>
            </div>
            <div class="chat-input">
                <form id="fm" action="" class="form-inline">
                  <div class="form-group">
                    <input id="m" autocomplete="off" type="text" class="form-control" placeholder="Type a message...">
                  </div>
                  <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button>
                </form>
            </div>
               <div class="panel panel-default">
                <canvas id="myCanvas" width="578" height="200"></canvas>
               </div>
              <form id="cm" action="" class="form-inline">
              <button id="clearCanvas" type="reset" value="Reset" class="btn btn-default"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
              <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-send" aria-hidden="true"></span></button>
            </form>
        </div>
    </div>
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous" type="text/javascript"></script>
    <script type="text/javascript">
//<![CDATA[
!function(t){"use strict";var e=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,o=t.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}(),n=o&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),r=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,a=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,i=(o||r)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(t){var e,i,l,u,b,c,d,B,f;if(e=t.match(a),!e)throw new Error("invalid data URI");for(i=e[2]?e[1]:"text/plain"+(e[3]||";charset=US-ASCII"),l=!!e[4],u=t.slice(e[0].length),b=l?atob(u):decodeURIComponent(u),c=new ArrayBuffer(b.length),d=new Uint8Array(c),B=0;B<b.length;B+=1)d[B]=b.charCodeAt(B);return o?new Blob([n?d:c],{type:i}):(f=new r,f.append(c),f.getBlob(i))};t.HTMLCanvasElement&&!e.toBlob&&(e.mozGetAsFile?e.toBlob=function(t,o,n){t(n&&e.toDataURL&&i?i(this.toDataURL(o,n)):this.mozGetAsFile("blob",o))}:e.toDataURL&&i&&(e.toBlob=function(t,e,o){t(i(this.toDataURL(e,o)))})),"function"==typeof define&&define.amd?define(function(){return i}):"object"==typeof module&&module.exports?module.exports=i:t.dataURLtoBlob=i}(window);
//# sourceMappingURL=canvas-to-blob.min.js.map
//]]>
    </script>
    <script type="text/javascript">
//<![CDATA[
$(function(){
    // Chat functions.
    function stopTyping(id) {
        delete isTyping[id]
        $('#typer'+id).remove()
    }

    function addChat(data){
        addToLogAndScroll(data.name, data.msg, "")
    }

    function addUpdate(message){
        addToLogAndScroll( 'Admin', message, "list-group-item update")
    }

    function addToLogAndScroll(userName, message, classType, img){
        var out = document.getElementById("chat-scroll")
        var isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + 1
        var panel = $('<div>').addClass("panel panel-default")
        panel.append($('<div>').addClass("panel-heading").text(userName))
        var panelBody = $('<div>').addClass("panel-body");
        if (typeof img !== "undefined") {
            panelBody.append($('<img>').attr("src", img.src))
        }
        else {
            panelBody.text(message)
        }
        panel.append(panelBody);
        $('#messages').append(panel)

        setTimeout(function() {
            if(isScrolledToBottom) {
                out.scrollTop = out.scrollHeight - out.clientHeight
            }
        }, 1);
    }

    // Canvas functions.
    function canvasBlob(user, blob) {
        socket.emit("blob", blob)
        var newImg = document.createElement("img"),
            url = URL.createObjectURL(blob)
        newImg.onload = function() {
            // no longer need to read the blob so it's revoked
            URL.revokeObjectURL(url)
        };
        newImg.src = url;
        placeChatImg(user, newImg);
    }

    function recieveBlob(user, blob) {
        var uint8Arr = new Uint8Array(blob);
        var binary = '';
        for (var i = 0; i < uint8Arr.length; i++) {
            binary += String.fromCharCode(uint8Arr[i]);
        }
        var base64String = window.btoa(binary);
        var img = new Image();
        img.onload = function() {
            placeChatImg(user, this)
        }
        img.src = 'data:image/png;base64,' + base64String;
    }

    function placeChatImg(user, img) {
        addToLogAndScroll(user.name, "", "", img)
    }

    // Painting functions
    function getMousePos(canvas, e) {
        var rect = canvas.getBoundingClientRect()
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        }
    }

    function onPaint() {
        context.lineTo(mouse.x, mouse.y);
        context.stroke();
    };

    // Chat globals.
    var isTyping = {}
    var localUser = {}

    // Connection.
    var socket = io()

    // Form functionality.
    $('#m').on('input', function() {
        socket.emit('is_typing');
    })

    $('#fm').submit(function(){
        var msg = $('#m').val()
        if (msg && msg.length > 0) {
            socket.emit('chat', msg)
            addChat(jQuery.extend({msg:msg}, localUser))
            $('#m').val('')
        }
        return false
    })

    $('#fn').submit(function(){
        var input = $('#n')
        var name = input.val()
        if (name && name.length > 0) {
            localUser.name = name
            socket.emit('name_change', name)
            input.attr('placeholder', name)
            addUpdate('You changed your name to  "' + name + '"')
        }
        return false
    })

    $('#clearCanvas').click(function(){
        var canvas = document.getElementById('myCanvas')
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return false
    })

    $('#cm').submit(function(){
        var canvas = document.getElementById('myCanvas');
        if (typeof canvas.toBlob !== "undefined") {
          canvas.toBlob(function(blob) {
              canvasBlob(localUser, blob);
          }, "image/png", 0.75);
        }
        else if (typeof canvas.msToBlob !== "undefined") {
          var blob = canvas.msToBlob()
          canvasBlob(localUser, blob)
        }
        return false
    })

    // Message handlers.
    socket.on('is_typing', function(user){
        if (user.id in isTyping){
            clearTimeout(isTyping[user.id])
        }
        else {
            $('#typers').append($('<li>').attr('id', 'typer'+user.id).text(user.name + "..."))
        }
        isTyping[user.id] = setTimeout(stopTyping, 2000, user.id, user.name)
    })

    socket.on('connection', function(user){
        localUser = user
        $('#n').attr('placeholder', user.name)
        addUpdate('Welcome, "' + user.name + '"!')
    })

    socket.on('chat', function(data){
        addChat(data)
        stopTyping(data.id)
    })

    socket.on('user_list', function(list){
        for (i = 0; i < list.length; i++) { 
            var user = list[i]
            $('#users').append($('<li>').attr('id', 'user'+user.id).text(user.name))
        }
    })

    socket.on('user_add', function(user){
        $('#users').append($('<li>').attr('id', 'user'+user.id).text(user.name))
        addUpdate('"' + user.name + '" joined.')
    })

    socket.on('user_remove', function(user){
        $('#user'+user.id).remove()
        addUpdate('"' + user.name + '" left.')
    })

    socket.on('name_change', function(user){
        var oldName = "server_error"
        var userList = $('#user'+user.id)
        oldName = userList.text()
        userList.text(user.name)
        addUpdate('"' + oldName + '" changed name to  "' + user.name + '"')
        if (user.id in isTyping){
            $('#typer'+user.id).text(user.name+"...");
        }
    })

    socket.on('blob', function(data){
        recieveBlob(data.user, data.blob)
    })


    // Painting globals
    var canvas = document.getElementById('myCanvas')
    var mouse = {x: 0, y: 0}
    var context = canvas.getContext('2d')


    canvas.addEventListener('mousemove', function(e) {
        mouse = getMousePos(canvas, e);
    }, false);

    canvas.addEventListener('mousedown', function(e) {
        mouse = getMousePos(canvas, e);
        context.beginPath();
        context.moveTo(mouse.x, mouse.y);
        canvas.addEventListener('mousemove', onPaint, false);
    }, false);


    canvas.addEventListener('mouseup', function() {
        canvas.removeEventListener('mousemove', onPaint, false);
    }, false);


});
//]]>
    </script>
</body>
</html>
